<!-- templates/statistics.html -->
{% extends "base.html" %}

{% block title %}الإحصائيات المتقدمة - محلل الشطرنج الجزائري{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-2xl shadow-xl p-8 mb-8" data-aos="fade-up">
        <div class="text-center">
            <div class="text-6xl mb-4">📈</div>
            <h1 class="text-4xl font-bold arabic-text mb-4">الإحصائيات المتقدمة والتقارير</h1>
            <p class="text-cyan-100 text-xl arabic-text">تحليل شامل لجميع جوانب لعبك</p>
        </div>
    </div>

    <!-- Quick Stats Dashboard -->
    <div class="grid lg:grid-cols-5 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 text-center" data-aos="fade-up" data-aos-delay="100">
            <div class="text-3xl mb-2">🎯</div>
            <div class="text-2xl font-bold text-blue-600" id="totalGames">{{ analysis.total_analyzed }}</div>
            <p class="text-gray-600 text-sm arabic-text">إجمالي المباريات</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 text-center" data-aos="fade-up" data-aos-delay="200">
            <div class="text-3xl mb-2">🏆</div>
            <div class="text-2xl font-bold text-green-600" id="winRate">
                {{ ((analysis.games|selectattr('player_result', 'equalto', 'فوز')|list|length / analysis.total_analyzed) * 100)|round(1) }}%
            </div>
            <p class="text-gray-600 text-sm arabic-text">معدل الفوز</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 text-center" data-aos="fade-up" data-aos-delay="300">
            <div class="text-3xl mb-2">⚡</div>
            <div class="text-2xl font-bold text-purple-600" id="avgMoves">
                {{ (analysis.games|sum(attribute='total_moves') / analysis.total_analyzed)|round(1) }}
            </div>
            <p class="text-gray-600 text-sm arabic-text">متوسط النقلات</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 text-center" data-aos="fade-up" data-aos-delay="400">
            <div class="text-3xl mb-2">🕐</div>
            <div class="text-2xl font-bold text-orange-600" id="totalTime">
                {{ (analysis.games|sum(attribute='game_duration') / 60)|round(1) }}
            </div>
            <p class="text-gray-600 text-sm arabic-text">ساعات اللعب</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 text-center" data-aos="fade-up" data-aos-delay="500">
            <div class="text-3xl mb-2">🎨</div>
            <div class="text-2xl font-bold text-indigo-600" id="openingsCount">
                {{ analysis.advanced_stats.openings_analysis.total_openings_count }}
            </div>
            <p class="text-gray-600 text-sm arabic-text">افتتاحيات مختلفة</p>
        </div>
    </div>

    <!-- Detailed Charts Section -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8" data-aos="fade-up" data-aos-delay="600">
        <h2 class="text-2xl font-bold mb-8 arabic-text text-center">📊 المخططات التفصيلية</h2>
        
        <div class="grid lg:grid-cols-2 gap-8 mb-8">
            <!-- Performance Over Time -->
            <div>
                <h3 class="text-xl font-bold mb-4 arabic-text">📈 الأداء عبر الوقت</h3>
                <div class="h-64">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
            
            <!-- Opening Success Rate -->
            <div>
                <h3 class="text-xl font-bold mb-4 arabic-text">🎯 معدل نجاح الافتتاحيات</h3>
                <div class="h-64">
                    <canvas id="openingsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Game Length Distribution -->
            <div>
                <h3 class="text-xl font-bold mb-4 arabic-text">📏 توزيع أطوال المباريات</h3>
                <div class="h-64">
                    <canvas id="lengthChart"></canvas>
                </div>
            </div>
            
            <!-- Color Performance -->
            <div>
                <h3 class="text-xl font-bold mb-4 arabic-text">⚪⚫ الأداء حسب اللون</h3>
                <div class="h-64">
                    <canvas id="colorPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Metrics -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8" data-aos="fade-up" data-aos-delay="700">
        <h2 class="text-2xl font-bold mb-8 arabic-text">🔬 المقاييس المتقدمة</h2>
        
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Consistency Score -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl">
                <h3 class="text-xl font-bold text-blue-800 mb-4 arabic-text">📊 نقاط الثبات</h3>
                <div class="text-center mb-4">
                    <div class="text-4xl font-bold text-blue-600" id="consistencyScore">8.5</div>
                    <div class="text-sm text-gray-600">/10</div>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-3">
                    <div class="bg-blue-600 h-3 rounded-full" style="width: 85%"></div>
                </div>
                <p class="text-sm text-gray-700 mt-3 arabic-text">
                    مستوى عالٍ من الثبات في الأداء
                </p>
            </div>

            <!-- Tactical Strength -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl">
                <h3 class="text-xl font-bold text-green-800 mb-4 arabic-text">⚔️ القوة التكتيكية</h3>
                <div class="text-center mb-4">
                    <div class="text-4xl font-bold text-green-600" id="tacticalScore">7.2</div>
                    <div class="text-sm text-gray-600">/10</div>
                </div>
                <div class="w-full bg-green-200 rounded-full h-3">
                    <div class="bg-green-600 h-3 rounded-full" style="width: 72%"></div>
                </div>
                <p class="text-sm text-gray-700 mt-3 arabic-text">
                    أداء جيد في المواقف التكتيكية
                </p>
            </div>

            <!-- Strategic Understanding -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl">
                <h3 class="text-xl font-bold text-purple-800 mb-4 arabic-text">🧠 الفهم الاستراتيجي</h3>
                <div class="text-center mb-4">
                    <div class="text-4xl font-bold text-purple-600" id="strategicScore">6.8</div>
                    <div class="text-sm text-gray-600">/10</div>
                </div>
                <div class="w-full bg-purple-200 rounded-full h-3">
                    <div class="bg-purple-600 h-3 rounded-full" style="width: 68%"></div>
                </div>
                <p class="text-sm text-gray-700 mt-3 arabic-text">
                    مجال للتحسين في التخطيط طويل المدى
                </p>
            </div>
        </div>
    </div>

    <!-- Monthly Progress Report -->
    <div class="bg-white rounded-2xl shadow-xl p-8" data-aos="fade-up" data-aos-delay="800">
        <h2 class="text-2xl font-bold mb-8 arabic-text">📅 تقرير التطور الشهري</h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-4 text-right arabic-text">الشهر</th>
                        <th class="p-4 text-center arabic-text">المباريات</th>
                        <th class="p-4 text-center arabic-text">الانتصارات</th>
                        <th class="p-4 text-center arabic-text">معدل الفوز</th>
                        <th class="p-4 text-center arabic-text">متوسط النقلات</th>
                        <th class="p-4 text-center arabic-text">الافتتاحية الأكثر</th>
                        <th class="p-4 text-center arabic-text">التقييم</th>
                    </tr>
                </thead>
                <tbody id="monthlyReport">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Initialize charts and statistics
document.addEventListener('DOMContentLoaded', function() {
    const analysisData = {{ analysis|tojson }};
    
    initializeCharts(analysisData);
    generateMonthlyReport(analysisData.games);
    calculateAdvancedMetrics(analysisData.games);
});

function initializeCharts(data) {
    createPerformanceChart(data.games);
    createOpeningsChart(data.advanced_stats.openings_analysis);
    createLengthChart(data.games);
    createColorPerformanceChart(data.advanced_stats.performance_by_color);
}

function createPerformanceChart(games) {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Group games by month
    const monthlyData = groupGamesByMonth(games);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyData.months,
            datasets: [{
                label: 'معدل الفوز (%)',
                data: monthlyData.winRates,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createOpeningsChart(openingsData) {
    const ctx = document.getElementById('openingsChart').getContext('2d');
    
    // Get top 5 openings by usage
    const whiteOpenings = Object.entries(openingsData.as_white)
        .sort(([,a], [,b]) => b.count - a.count)
        .slice(0, 5);
    
    const labels = whiteOpenings.map(([key, data]) => data.info.name.substring(0, 15) + '...');
    const winRates = whiteOpenings.map(([key, data]) => data.win_rate);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'معدل النجاح (%)',
                data: winRates,
                backgroundColor: [
                    '#10b981',
                    '#3b82f6', 
                    '#8b5cf6',
                    '#f59e0b',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createLengthChart(games) {
    const ctx = document.getElementById('lengthChart').getContext('2d');
    
    const short = games.filter(g => g.total_moves < 30).length;
    const medium = games.filter(g => g.total_moves >= 30 && g.total_moves < 60).length;
    const long = games.filter(g => g.total_moves >= 60).length;
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['قصيرة (< 30)', 'متوسطة (30-60)', 'طويلة (> 60)'],
            datasets: [{
                data: [short, medium, long],
                backgroundColor: ['#f59e0b', '#3b82f6', '#8b5cf6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createColorPerformanceChart(colorData) {
    const ctx = document.getElementById('colorPerformanceChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['الانتصارات', 'الهزائم', 'التعادل', 'معدل الفوز', 'إجمالي المباريات'],
            datasets: [{
                label: 'الأبيض',
                data: [
                    colorData.white.wins,
                    colorData.white.losses,
                    colorData.white.draws,
                    colorData.white.win_rate,
                    colorData.white.games
                ],
                borderColor: '#e5e7eb',
                backgroundColor: 'rgba(229, 231, 235, 0.2)'
            }, {
                label: 'الأسود',
                data: [
                    colorData.black.wins,
                    colorData.black.losses,
                    colorData.black.draws,
                    colorData.black.win_rate,
                    colorData.black.games
                ],
                borderColor: '#374151',
                backgroundColor: 'rgba(55, 65, 81, 0.2)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true
                }
            }
        }
    });
}

function groupGamesByMonth(games) {
    const monthlyStats = {};
    
    games.forEach(game => {
        const date = new Date(game.date);
        const monthKey = date.toISOString().substring(0, 7); // YYYY-MM format
        
        if (!monthlyStats[monthKey]) {
            monthlyStats[monthKey] = { games: 0, wins: 0 };
        }
        
        monthlyStats[monthKey].games++;
        if (game.player_result === 'فوز') {
            monthlyStats[monthKey].wins++;
        }
    });
    
    const months = Object.keys(monthlyStats).sort();
    const winRates = months.map(month => {
        const stats = monthlyStats[month];
        return stats.games > 0 ? (stats.wins / stats.games * 100) : 0;
    });
    
    return { months, winRates };
}

function generateMonthlyReport(games) {
    const monthlyData = groupGamesByMonth(games);
    const tableBody = document.getElementById('monthlyReport');
    
    // Create detailed monthly statistics
    const monthlyStats = {};
    
    games.forEach(game => {
        const date = new Date(game.date);
        const monthKey = date.toISOString().substring(0, 7);
        
        if (!monthlyStats[monthKey]) {
            monthlyStats[monthKey] = {
                games: 0,
                wins: 0,
                totalMoves: 0,
                openings: {}
            };
        }
        
        const stats = monthlyStats[monthKey];
        stats.games++;
        stats.totalMoves += game.total_moves;
        
        if (game.player_result === 'فوز') stats.wins++;
        
        stats.openings[game.opening] = (stats.openings[game.opening] || 0) + 1;
    });
    
    // Generate table rows
    Object.entries(monthlyStats)
        .sort(([a], [b]) => b.localeCompare(a))
        .slice(0, 6) // Last 6 months
        .forEach(([month, stats]) => {
            const winRate = Math.round((stats.wins / stats.games) * 100);
            const avgMoves = Math.round(stats.totalMoves / stats.games);
            const topOpening = Object.entries(stats.openings)
                .sort(([,a], [,b]) => b - a)[0]?.[0] || 'غير محدد';
            
            const rating = calculateMonthRating(winRate, avgMoves, stats.games);
            
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="p-4 font-semibold">${formatMonth(month)}</td>
                <td class="p-4 text-center">${stats.games}</td>
                <td class="p-4 text-center">${stats.wins}</td>
                <td class="p-4 text-center">
                    <span class="px-2 py-1 rounded-full text-xs font-semibold
                        ${winRate >= 60 ? 'bg-green-100 text-green-800' : 
                          winRate >= 40 ? 'bg-yellow-100 text-yellow-800' : 
                          'bg-red-100 text-red-800'}">
                        ${winRate}%
                    </span>
                </td>
                <td class="p-4 text-center">${avgMoves}</td>
                <td class="p-4 text-center text-sm">${topOpening.substring(0, 15)}...</td>
                <td class="p-4 text-center">
                    <span class="font-bold ${rating >= 8 ? 'text-green-600' : rating >= 6 ? 'text-yellow-600' : 'text-red-600'}">
                        ${rating}/10
                    </span>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
}

function calculateAdvancedMetrics(games) {
    // Calculate consistency score (based on variance in performance)
    const monthlyWinRates = groupGamesByMonth(games).winRates;
    const avgWinRate = monthlyWinRates.reduce((sum, rate) => sum + rate, 0) / monthlyWinRates.length;
    const variance = monthlyWinRates.reduce((sum, rate) => sum + Math.pow(rate - avgWinRate, 2), 0) / monthlyWinRates.length;
    const consistency = Math.max(0, 10 - (variance / 100));
    
    document.getElementById('consistencyScore').textContent = consistency.toFixed(1);
    
    // Update tactical score (based on quick wins and avoiding quick losses)
    const quickWins = games.filter(g => g.player_result === 'فوز' && g.total_moves < 25).length;
    const quickLosses = games.filter(g => g.player_result === 'خسارة' && g.total_moves < 25).length;
    const tactical = Math.max(0, Math.min(10, 5 + (quickWins * 2) - (quickLosses * 3)));
    
    document.getElementById('tacticalScore').textContent = tactical.toFixed(1);
    
    // Strategic score (based on long game performance)
    const longGames = games.filter(g => g.total_moves > 50);
    const longGameWins = longGames.filter(g => g.player_result === 'فوز').length;
    const strategic = longGames.length > 0 ? (longGameWins / longGames.length) * 10 : 5;
    
    document.getElementById('strategicScore').textContent = strategic.toFixed(1);
}

function formatMonth(monthStr) {
    const months = [
        'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
        'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
    ];
    
    const [year, month] = monthStr.split('-');
    return `${months[parseInt(month) - 1]} ${year}`;
}

function calculateMonthRating(winRate, avgMoves, games) {
    let rating = 5; // Base rating
    
    // Win rate factor
    if (winRate >= 70) rating += 3;
    else if (winRate >= 50) rating += 1;
    else if (winRate < 30) rating -= 2;
    
    // Game quality factor (balanced game length)
    if (avgMoves >= 35 && avgMoves <= 55) rating += 1;
    
    // Activity factor
    if (games >= 20) rating += 1;
    else if (games < 5) rating -= 1;
    
    return Math.max(1, Math.min(10, Math.round(rating)));
}
</script>

<!-- Chart.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
{% endblock %}
