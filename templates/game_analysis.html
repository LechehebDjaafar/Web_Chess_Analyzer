{% extends "base.html" %}

{% block title %}ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© - {{ game.white_player }} Ø¶Ø¯ {{ game.black_player }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Game Header -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-2xl shadow-xl p-8 mb-8" data-aos="fade-up">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold arabic-text mb-2">
                    ğŸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…ÙØµÙ„
                </h1>
                <p class="text-purple-100 arabic-text">
                    {{ game.white_player }} âšª Ø¶Ø¯ âš« {{ game.black_player }}
                </p>
            </div>
            <div class="text-right">
                <div class="text-4xl font-bold mb-2">
                    {% if game.player_result == 'ÙÙˆØ²' %}ğŸ†
                    {% elif game.player_result == 'Ø®Ø³Ø§Ø±Ø©' %}ğŸ˜”
                    {% else %}ğŸ¤{% endif %}
                </div>
                <div class="text-lg">{{ game.player_result }}</div>
            </div>
        </div>
        
        <!-- Game Info -->
        <div class="grid md:grid-cols-4 gap-4 bg-white bg-opacity-20 rounded-xl p-4">
            <div class="text-center">
                <div class="font-semibold">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
                <div>{{ game.date }}</div>
            </div>
            <div class="text-center">
                <div class="font-semibold">Ø§Ù„Ù†Ù‚Ù„Ø§Øª</div>
                <div>{{ game.total_moves }}</div>
            </div>
            <div class="text-center">
                <div class="font-semibold">Ø§Ù„Ù…Ø¯Ø©</div>
                <div>{{ game.game_duration }} Ø¯Ù‚ÙŠÙ‚Ø©</div>
            </div>
            <div class="text-center">
                <div class="font-semibold">Ø§Ù„Ù†ÙˆØ¹</div>
                <div>{% if game.rated %}Ù…ÙÙ‚ÙŠÙ…Ø©{% else %}ØºÙŠØ± Ù…ÙÙ‚ÙŠÙ…Ø©{% endif %}</div>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
        <!-- Chess Board Column -->
        <div class="lg:col-span-2">
            <!-- Board Container -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6" data-aos="fade-up">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold arabic-text">ğŸ Ø±Ù‚Ø¹Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬</h2>
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="resetBoard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300">
                            Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„
                        </button>
                        <button onclick="flipBoard()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                            Ù‚Ù„Ø¨ Ø§Ù„Ø±Ù‚Ø¹Ø©
                        </button>
                    </div>
                </div>
                
                <!-- Chess Board -->
                <div id="chessboard" class="mx-auto mb-6" style="width: 100%; max-width: 500px;"></div>
                
                <!-- Board Controls -->
                <div class="flex justify-center items-center space-x-4 space-x-reverse mb-4">
                    <button onclick="previousMove()" id="prevBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300" disabled>
                        â† Ø§Ù„Ø³Ø§Ø¨Ù‚
                    </button>
                    <button onclick="playPause()" id="playBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300">
                        â–¶ï¸ ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    </button>
                    <button onclick="nextMove()" id="nextBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                        Ø§Ù„ØªØ§Ù„ÙŠ â†’
                    </button>
                </div>
                
                <!-- Move Counter -->
                <div class="text-center">
                    <span class="text-lg font-semibold">Ø§Ù„Ù†Ù‚Ù„Ø©: </span>
                    <span id="currentMove" class="text-2xl font-bold text-blue-600">0</span>
                    <span class="text-lg"> Ù…Ù† {{ game.total_moves }}</span>
                </div>
            </div>

            <!-- Analysis Controls -->
            <div class="bg-white rounded-2xl shadow-xl p-6" data-aos="fade-up" data-aos-delay="100">
                <h3 class="text-xl font-bold mb-4 arabic-text">ğŸ” ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù…</h3>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <button onclick="startEngineAnalysis()" id="analyzeBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-6 rounded-xl hover:from-purple-700 hover:to-pink-700 transition duration-300">
                        ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ù…Ø­Ø±Ùƒ
                    </button>
                    <button onclick="showOpeningAnalysis()" class="bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 px-6 rounded-xl hover:from-green-700 hover:to-blue-700 transition duration-300">
                        ğŸ“š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©
                    </button>
                </div>
                
                <!-- Analysis Results -->
                <div id="analysisResults" class="hidden bg-gray-50 rounded-xl p-4">
                    <h4 class="font-bold mb-3 arabic-text">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„:</h4>
                    <div id="analysisContent"></div>
                </div>
            </div>
        </div>

        <!-- Moves and Info Column -->
        <div class="space-y-6">
            <!-- Current Move Info -->
            <div class="bg-white rounded-2xl shadow-xl p-6" data-aos="fade-up" data-aos-delay="200">
                <h3 class="text-xl font-bold mb-4 arabic-text">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div id="currentMoveInfo" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        Ø§Ø®ØªØ± Ù†Ù‚Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                    </div>
                </div>
            </div>

            <!-- Moves List -->
            <div class="bg-white rounded-2xl shadow-xl p-6" data-aos="fade-up" data-aos-delay="300">
                <h3 class="text-xl font-bold mb-4 arabic-text">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ù„Ø§Øª</h3>
                <div id="movesList" class="space-y-2 max-h-96 overflow-y-auto">
                    {% for move in game.moves %}
                    <div class="move-item flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200"
                         data-move-number="{{ loop.index0 }}"
                         onclick="goToMove({{ loop.index0 }})">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-semibold">
                                {{ move.number }}
                            </span>
                            <span class="font-bold text-lg">{{ move.move }}</span>
                            <span class="text-xs text-gray-500">
                                {% if move.color == 'white' %}âšª{% else %}âš«{% endif %}
                            </span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Game Statistics -->
            <div class="bg-white rounded-2xl shadow-xl p-6" data-aos="fade-up" data-aos-delay="400">
                <h3 class="text-xl font-bold mb-4 arabic-text">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</h3>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©:</span>
                        <span class="font-semibold">{{ game.opening }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ù„ÙˆÙ†Ùƒ:</span>
                        <span class="font-semibold">
                            {% if game.player_color == 'white' %}Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ âšª{% else %}Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ âš«{% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ø§Ù„Ø®ØµÙ…:</span>
                        <span class="font-semibold">{{ game.opponent }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø²Ù…Ù†ÙŠ:</span>
                        <span class="font-semibold">{{ game.time_control }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</span>
                        <span class="font-semibold {{ 'text-green-600' if game.player_result == 'ÙÙˆØ²' else 'text-red-600' if game.player_result == 'Ø®Ø³Ø§Ø±Ø©' else 'text-yellow-600' }}">
                            {{ game.result }}
                        </span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-6 space-y-2">
                    <button onclick="downloadPGN()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                        ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PGN
                    </button>
                    <button onclick="shareGame()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                        ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
                    </button>
                    {% if game.url %}
                    <a href="{{ game.url }}" target="_blank" class="block w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-300 text-center">
                        ğŸŒ Ø¹Ø±Ø¶ ÙÙŠ Chess.com
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chessboard.js -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://unpkg.com/chess.js@1.0.0/chess.min.js"></script>

<script>
// Game data
const gameData = {{ game|tojson }};
const moves = gameData.moves;

// Chess game state
let chess = new Chess();
let board = null;
let currentMoveIndex = -1;
let isPlaying = false;
let playInterval = null;

// Initialize chess board
function initBoard() {
    const config = {
        draggable: false,
        position: 'start',
        showNotation: true,
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    };
    
    board = Chessboard('chessboard', config);
    
    // Resize board responsively
    window.addEventListener('resize', board.resize);
}

// Move navigation
function nextMove() {
    if (currentMoveIndex < moves.length - 1) {
        currentMoveIndex++;
        const move = moves[currentMoveIndex];
        
        try {
            chess.move(move.move);
            board.position(chess.fen());
            updateMoveDisplay();
            highlightCurrentMove();
            showMoveInfo(move, currentMoveIndex);
        } catch (error) {
            console.error('Invalid move:', move.move, error);
        }
    }
    
    updateButtons();
}

function previousMove() {
    if (currentMoveIndex >= 0) {
        chess.undo();
        currentMoveIndex--;
        board.position(chess.fen());
        updateMoveDisplay();
        highlightCurrentMove();
        
        if (currentMoveIndex >= 0) {
            showMoveInfo(moves[currentMoveIndex], currentMoveIndex);
        } else {
            clearMoveInfo();
        }
    }
    
    updateButtons();
}

function goToMove(moveIndex) {
    // Reset to start
    chess = new Chess();
    currentMoveIndex = -1;
    
    // Play moves up to target
    for (let i = 0; i <= moveIndex; i++) {
        if (i < moves.length) {
            try {
                chess.move(moves[i].move);
                currentMoveIndex = i;
            } catch (error) {
                console.error('Error going to move:', i, moves[i].move);
                break;
            }
        }
    }
    
    board.position(chess.fen());
    updateMoveDisplay();
    highlightCurrentMove();
    
    if (currentMoveIndex >= 0) {
        showMoveInfo(moves[currentMoveIndex], currentMoveIndex);
    }
    
    updateButtons();
}

function resetBoard() {
    chess = new Chess();
    board.position('start');
    currentMoveIndex = -1;
    updateMoveDisplay();
    clearMoveInfo();
    clearMoveHighlight();
    updateButtons();
    
    if (isPlaying) {
        playPause();
    }
}

function flipBoard() {
    board.flip();
}

// Auto play functionality
function playPause() {
    const playBtn = document.getElementById('playBtn');
    
    if (isPlaying) {
        clearInterval(playInterval);
        playBtn.textContent = 'â–¶ï¸ ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ';
        isPlaying = false;
    } else {
        playBtn.textContent = 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù';
        isPlaying = true;
        
        playInterval = setInterval(() => {
            if (currentMoveIndex < moves.length - 1) {
                nextMove();
            } else {
                playPause();
            }
        }, 1500);
    }
}

// UI Updates
function updateMoveDisplay() {
    document.getElementById('currentMove').textContent = currentMoveIndex + 1;
}

function updateButtons() {
    document.getElementById('prevBtn').disabled = currentMoveIndex < 0;
    document.getElementById('nextBtn').disabled = currentMoveIndex >= moves.length - 1;
}

function highlightCurrentMove() {
    clearMoveHighlight();
    
    if (currentMoveIndex >= 0) {
        const moveElement = document.querySelector(`[data-move-number="${currentMoveIndex}"]`);
        if (moveElement) {
            moveElement.classList.add('bg-blue-100', 'border-2', 'border-blue-500');
        }
    }
}

function clearMoveHighlight() {
    document.querySelectorAll('.move-item').forEach(item => {
        item.classList.remove('bg-blue-100', 'border-2', 'border-blue-500');
    });
}

function showMoveInfo(move, index) {
    const info = document.getElementById('currentMoveInfo');
    const evaluation = chess.in_check() ? 'Ø´Ø§Ù‡!' : chess.in_checkmate() ? 'Ø´Ø§Ù‡ Ù…Ø§Øª!' : chess.in_stalemate() ? 'Ø¬Ù…ÙˆØ¯!' : 'Ø·Ø¨ÙŠØ¹ÙŠØ©';
    
    info.innerHTML = `
        <div class="space-y-3">
            <div class="text-center">
                <span class="text-3xl font-bold text-blue-600">${move.move}</span>
                <div class="text-sm text-gray-500">Ø§Ù„Ù†Ù‚Ù„Ø© Ø±Ù‚Ù… ${index + 1}</div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="font-semibold text-gray-700">Ø§Ù„Ù„Ø§Ø¹Ø¨</div>
                    <div>${move.color === 'white' ? 'Ø§Ù„Ø£Ø¨ÙŠØ¶ âšª' : 'Ø§Ù„Ø£Ø³ÙˆØ¯ âš«'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="font-semibold text-gray-700">Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
                    <div class="${evaluation.includes('Ø´Ø§Ù‡') ? 'text-red-600 font-bold' : ''}">${evaluation}</div>
                </div>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-lg">
                <div class="font-semibold text-blue-800 mb-1">Ù…ÙˆØ¶Ø¹ FEN:</div>
                <code class="text-xs break-all text-blue-600">${move.fen}</code>
            </div>
        </div>
    `;
}

function clearMoveInfo() {
    document.getElementById('currentMoveInfo').innerHTML = `
        <div class="text-center py-8 text-gray-500">
            Ø§Ø®ØªØ± Ù†Ù‚Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        </div>
    `;
}

// Analysis functions
function startEngineAnalysis() {
    const btn = document.getElementById('analyzeBtn');
    const resultsDiv = document.getElementById('analysisResults');
    const contentDiv = document.getElementById('analysisContent');
    
    btn.disabled = true;
    btn.textContent = 'ğŸ”„ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„...';
    
    // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ
    setTimeout(() => {
        const currentPos = chess.fen();
        const moveNumber = currentMoveIndex + 1;
        
        // ØªØ­Ù„ÙŠÙ„ Ø¨Ø³ÙŠØ· (ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø³ØªØ³ØªØ®Ø¯Ù… Stockfish)
        const analysis = {
            evaluation: Math.random() * 4 - 2, // ØªÙ‚ÙŠÙŠÙ… Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©
            bestMoves: ['Nf3', 'e4', 'd4'], // Ù†Ù‚Ù„Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©
            depth: 15
        };
        
        contentDiv.innerHTML = `
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ¶Ø¹:</span>
                    <span class="font-bold ${analysis.evaluation > 0 ? 'text-green-600' : analysis.evaluation < 0 ? 'text-red-600' : 'text-gray-600'}">
                        ${analysis.evaluation > 0 ? '+' : ''}${analysis.evaluation.toFixed(2)}
                    </span>
                </div>
                <div>
                    <div class="font-semibold mb-1">Ø£ÙØ¶Ù„ Ø§Ù„Ù†Ù‚Ù„Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</div>
                    <div class="flex space-x-2 space-x-reverse">
                        ${analysis.bestMoves.map(move => `
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-mono">${move}</span>
                        `).join('')}
                    </div>
                </div>
                <div class="text-xs text-gray-500">
                    Ø§Ù„Ø¹Ù…Ù‚: ${analysis.depth} â€¢ Ø§Ù„ÙˆÙ‚Øª: 2.3 Ø«Ø§Ù†ÙŠØ©
                </div>
            </div>
        `;
        
        resultsDiv.classList.remove('hidden');
        btn.disabled = false;
        btn.textContent = 'ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ù…Ø­Ø±Ùƒ';
        
    }, 2000);
}

function showOpeningAnalysis() {
    const contentDiv = document.getElementById('analysisContent');
    const resultsDiv = document.getElementById('analysisResults');
    
    contentDiv.innerHTML = `
        <div class="space-y-3">
            <div>
                <div class="font-semibold text-green-800 mb-2">ğŸ“š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©</div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <h4 class="font-bold">${gameData.opening}</h4>
                    <p class="text-sm text-gray-600 mt-2">
                        Ù‡Ø°Ù‡ Ø§ÙØªØªØ§Ø­ÙŠØ© Ø´Ø§Ø¦Ø¹Ø© ÙˆÙ‚ÙˆÙŠØ©. Ø§Ù„Ù†Ù‚Ù„Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªÙ‡Ø¯Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ù‚Ø·Ø¹ Ø¨Ø³Ø±Ø¹Ø©.
                    </p>
                </div>
            </div>
            
            <div>
                <div class="font-semibold mb-2">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:</div>
                <ul class="text-sm space-y-1">
                    <li>â€¢ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²</li>
                    <li>â€¢ ØªØ·ÙˆÙŠØ± Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„ØµØºÙŠØ±Ø©</li>
                    <li>â€¢ Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù„Ùƒ</li>
                    <li>â€¢ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‡Ø¯ÙŠØ¯Ø§Øª ØªÙƒØªÙŠÙƒÙŠØ©</li>
                </ul>
            </div>
        </div>
    `;
    
    resultsDiv.classList.remove('hidden');
}

// Utility functions
function downloadPGN() {
    const pgn = gameData.pgn || generatePGN();
    const blob = new Blob([pgn], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `game-${gameData.white_player}-vs-${gameData.black_player}-${gameData.date}.pgn`;
    link.click();
    
    URL.revokeObjectURL(url);
}

function generatePGN() {
    let pgn = `[Event "Chess.com Analysis"]\n`;
    pgn += `[Date "${gameData.date}"]\n`;
    pgn += `[White "${gameData.white_player}"]\n`;
    pgn += `[Black "${gameData.black_player}"]\n`;
    pgn += `[Result "${gameData.result}"]\n\n`;
    
    const movesPGN = moves.reduce((acc, move, index) => {
        if (index % 2 === 0) {
            acc += `${Math.floor(index / 2) + 1}. `;
        }
        acc += `${move.move} `;
        return acc;
    }, '');
    
    pgn += movesPGN + gameData.result;
    
    return pgn;
}

function shareGame() {
    if (navigator.share) {
        navigator.share({
            title: `Ù…Ø¨Ø§Ø±Ø§Ø© Ø´Ø·Ø±Ù†Ø¬: ${gameData.white_player} Ø¶Ø¯ ${gameData.black_player}`,
            text: `Ø´Ø§Ù‡Ø¯ ØªØ­Ù„ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…Ø«ÙŠØ±Ø©`,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©!');
        });
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initBoard();
    updateButtons();
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    document.addEventListener('keydown', function(e) {
        switch(e.key) {
            case 'ArrowRight':
                nextMove();
                break;
            case 'ArrowLeft':
                previousMove();
                break;
            case ' ':
                e.preventDefault();
                playPause();
                break;
            case 'Home':
                resetBoard();
                break;
        }
    });
});
</script>
{% endblock %}
